<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çª„Ç≠„É•„Ç¢Êõ∏Áîª„Ç´„É°„É© V7</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
        .video-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        video { position: absolute; background: #000; transition: transform 0.2s ease-out; will-change: transform; }
        .controls { height: 100px; background: #1a1a1a; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; box-sizing: border-box; border-top: 1px solid #333; z-index: 100; }
        button { font-size: 16px; border-radius: 12px; border: none; color: white; cursor: pointer; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        button:active { opacity: 0.7; }
        .btn-sm { background: #28a745; } /* ÈÖç‰ø° */
        .btn-pc { background: #0066ff; } /* Ë¶ñËÅ¥ */
        .btn-rot { background: #444; }    /* ÂõûËª¢ */
        .icon { font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="video-container" id="container">
        <video id="videoView" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button class="btn-sm" onclick="startCamera()"><span class="icon">üì±</span>‚ë† ÈÖç‰ø°</button>
        <button class="btn-pc" onclick="startMonitor()"><span class="icon">üíª</span>‚ë° Ë¶ñËÅ¥</button>
        <button class="btn-rot" onclick="toggleRotate()"><span class="icon">üîÑ</span>‚ë¢ ÂõûËª¢</button>
    </div>

    <script>
        const BASE_ID = 'skk-v7-final-'; 
        let peer = null;
        let rotation = 0;
        let localStream = null;

        // ‚ë† ÈÖç‰ø°ÈñãÂßãÔºà„Çπ„Éû„ÉõÂÅ¥Ôºâ
        async function startCamera() {
            const pass = prompt("„Äê„Çπ„Éû„Éõ„ÄëÈÖç‰ø°„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊ±∫„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ");
            if (!pass) return;

            const targetID = BASE_ID + pass;
            if (peer) peer.destroy();
            
            peer = new Peer(targetID, { debug: 1 });
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 3840 }, height: { ideal: 2160 }, facingMode: "environment", frameRate: { max: 15 } },
                    audio: false
                });
                
                document.getElementById('videoView').srcObject = localStream;

                peer.on('open', () => {
                    alert("„ÄêÈÖç‰ø°‰∏≠„Äë\nPC„Åß‚ë°Ë¶ñËÅ¥„ÇíÊäº„Åó„ÄÅ„Äå" + pass + "„Äç„Å®ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÔºà„Åì„ÅÆÁîªÈù¢„ÅØÈñâ„Åò„Åö„Å´ÂæÖÊ©ü„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ");
                });

                peer.on('call', call => {
                    call.answer(localStream);
                    setupHighBitrate(call);
                });

                document.getElementById('videoView').onloadedmetadata = () => updateLayout();
            } catch (err) { alert("„Ç´„É°„É©„Ç®„É©„Éº: " + err); }
        }

        // ‚ë° Ë¶ñËÅ¥ÈñãÂßãÔºàPCÂÅ¥Ôºâ
        function startMonitor() {
            const pass = prompt("„ÄêPC„Äë„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            if (!pass) return;

            const targetID = BASE_ID + pass;
            if (peer) peer.destroy();
            
            // Ë¶ñËÅ¥ÂÅ¥„ÅØËá™Ë∫´„ÅÆID„ÅØ„É©„É≥„ÉÄ„É†
            peer = new Peer({ debug: 1 });
            
            peer.on('open', () => {
                const video = document.getElementById('videoView');
                
                // Êé•Á∂ö„ÇíË©¶Ë°å„Åô„ÇãÈñ¢Êï∞Ôºà„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
                const connect = () => {
                    const call = peer.call(targetID, new MediaStream());
                    
                    call.on('stream', stream => {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => updateLayout();
                        // „Éñ„É©„Ç¶„Ç∂„Å´„Çà„ÇãËá™ÂãïÂÜçÁîü„Éñ„É≠„ÉÉ„ÇØÂØæÁ≠ñ
                        video.play().catch(() => {
                            alert("ÁîªÈù¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êò†ÂÉè„ÇíË°®Á§∫„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ");
                        });
                    });
                };

                connect();

                // Êò†ÂÉè„ÅåÂ±ä„Åã„Å™„ÅÑÂ†¥Âêà„ÅÆËá™Âãï„É™„Éà„É©„Ç§
                setTimeout(() => {
                    if (!video.srcObject) {
                        console.log("ÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Åæ„Åô...");
                        connect();
                    }
                }, 2000);

                // ÊúÄÁµÇ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                setTimeout(() => {
                    if (!video.srcObject) alert("Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Çπ„Éû„ÉõÂÅ¥„ÅÆÈÖç‰ø°„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                }, 7000);
            });
        }

        function setupHighBitrate(call) {
            const pc = call.peerConnection;
            pc.oniceconnectionstatechange = async () => {
                if (pc.iceConnectionState === 'connected') {
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        params.encodings[0].maxBitrate = 20000000;
                        params.encodings[0].scaleResolutionDownBy = 1.0;
                        await sender.setParameters(params);
                    }
                }
            };
        }

        function toggleRotate() { rotation = (rotation + 90) % 360; updateLayout(); }

        function updateLayout() {
            const video = document.getElementById('videoView');
            const container = document.getElementById('container');
            if (!video.videoWidth) return;
            const cW = container.clientWidth; const cH = container.clientHeight;
            let scale = (rotation === 0 || rotation === 180) 
                        ? Math.min(cW / video.videoWidth, cH / video.videoHeight) 
                        : Math.min(cW / video.videoHeight, cH / video.videoWidth);
            video.style.width = video.videoWidth + "px";
            video.style.height = video.videoHeight + "px";
            video.style.transform = `rotate(${rotation}deg) scale(${scale})`;
        }
        window.addEventListener('resize', updateLayout);
    </script>
</body>
</html>
