<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ç”»è³ªæ›¸ç”»ã‚«ãƒ¡ãƒ©ãƒ»ãƒ—ãƒ­</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            background: #000; 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
        }

        /* æ˜ åƒã‚¨ãƒªã‚¢ï¼šå›è»¢ã—ã¦ã‚‚ã¯ã¿å‡ºã•ãšã€ã‹ã¤å°ã•ããªã‚Šã™ããªã„ã‚ˆã†èª¿æ•´ */
        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            overflow: hidden;
        }

        video { 
            position: absolute;
            max-width: 100%; 
            max-height: 100%; 
            background: #000; 
            transition: transform 0.4s ease-in-out; 
            object-fit: contain;
        }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šé«˜ã•ã‚’ååˆ†ã«ç¢ºä¿ã—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ã */
        .controls { 
            height: 220px; 
            background: #2c2c2c; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            padding: 12px;
            box-sizing: border-box;
            border-top: 3px solid #555;
            z-index: 100;
        }

        button { 
            padding: 8px 4px; 
            font-size: 15px; 
            border-radius: 12px; 
            border: 1px solid #666; 
            background: #4a4a4a; 
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        button:active { background: #777; }
        .btn-main { background: #0066ff; border-color: #0088ff; } /* è¦–è´ */
        .btn-sub { background: #228b22; border-color: #32cd32; } /* é…ä¿¡ */
        .btn-action { background: #606060; } /* ä¸‹æ®µã®ãƒœã‚¿ãƒ³ */
        
        .status { 
            grid-column: span 3; 
            font-size: 13px; 
            color: #afff00; 
            background: #000; 
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 4px;
            overflow: hidden;
            white-space: nowrap;
        }

        .icon { font-size: 22px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="video-container" id="container">
        <video id="videoView" autoplay playsinline></video>
    </div>

    <div class="controls">
        <div class="status" id="statusMsg">æº–å‚™å®Œäº†ï¼šPCãªã‚‰â‘ ã€ã‚¹ãƒãƒ›ãªã‚‰â‘¡ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        
        <button class="btn-main" onclick="startMonitor()">
            <span class="icon">ğŸ’»</span>â‘  PC<br>è¦–è´é–‹å§‹
        </button>
        <button class="btn-sub" onclick="startCamera()">
            <span class="icon">ğŸ“±</span>â‘¡ ã‚¹ãƒãƒ›<br>é…ä¿¡é–‹å§‹
        </button>
        <button onclick="location.reload()">
            <span class="icon">ğŸ”ƒ</span>ç”»é¢<br>ãƒªã‚»ãƒƒãƒˆ
        </button>
        
        <button class="btn-action" onclick="toggleRotate()">
            <span class="icon">ğŸ”„</span>æ˜ åƒã‚’<br>å›è»¢
        </button>
        <button class="btn-action" onclick="toggleLight()">
            <span class="icon">ğŸ’¡</span>ãƒ©ã‚¤ãƒˆ<br>ON/OFF
        </button>
        <button class="btn-action" onclick="toggleZoom()">
            <span class="icon">ğŸ”</span>ã‚ºãƒ¼ãƒ <br>åˆ‡æ›¿
        </button>
    </div>

    <script>
        const MONITOR_ID = 'seikeikai-monitor-2026';
        let peer = new Peer({ debug: 1 });
        let localStream;
        let rotation = 0;
        let isZoomed = false;

        function startMonitor() {
            if (peer) peer.destroy();
            peer = new Peer(MONITOR_ID);
            peer.on('open', () => {
                document.getElementById('statusMsg').innerText = "PCï¼šå¾…æ©Ÿä¸­... ã‚¹ãƒãƒ›ã‚’æ“ä½œã—ã¦ãã ã•ã„ã€‚";
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    document.getElementById('videoView').srcObject = stream;
                    document.getElementById('statusMsg').innerText = "å—ä¿¡ä¸­ï¼šé«˜è§£åƒåº¦ãƒ¢ãƒ¼ãƒ‰";
                });
            });
        }

        async function startCamera() {
            document.getElementById('statusMsg').innerText = "ã‚¹ãƒãƒ›ï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
            const constraints = {
                video: {
                    width: { ideal: 3840, min: 1920 },
                    height: { ideal: 2160, min: 1080 },
                    facingMode: "environment",
                    frameRate: { max: 15 }
                },
                audio: false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('videoView').srcObject = localStream;
                const call = peer.call(MONITOR_ID, localStream);
                
                const pc = call.peerConnection;
                pc.oniceconnectionstatechange = async () => {
                    if (pc.iceConnectionState === 'connected') {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        params.encodings[0].maxBitrate = 20000000;
                        params.encodings[0].scaleResolutionDownBy = 1.0; 
                        await sender.setParameters(params);
                        document.getElementById('statusMsg').innerText = "é«˜è§£åƒåº¦é€šä¿¡ã‚’ç¢ºç«‹ã—ã¾ã—ãŸ";
                    }
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err);
            }
        }

        function toggleRotate() { 
            rotation = (rotation + 90) % 360; 
            updateTransform(); 
        }

        function toggleZoom() { 
            isZoomed = !isZoomed; 
            updateTransform(); 
        }

        function updateTransform() {
            const video = document.getElementById('videoView');
            const container = document.getElementById('container');
            
            let scale = isZoomed ? 2.0 : 1.0;
            
            // å›è»¢ãŒ90åº¦/270åº¦ã®æ™‚ã€ç¸¦é•·ã«ãªã‚‹ã®ã§è‡ªå‹•ã§æ‹¡å¤§ã—ã¦ç”»é¢ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹
            if (rotation === 90 || rotation === 270) {
                const containerRatio = container.clientWidth / container.clientHeight;
                const videoRatio = video.videoWidth / video.videoHeight || 1.77;
                // ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹ãŸã‚ã®å€ç‡è¨ˆç®—
                scale *= Math.max(container.clientWidth / video.clientHeight, container.clientHeight / video.clientWidth) * 0.9;
            }
            
            video.style.transform = `rotate(${rotation}deg) scale(${scale})`;
        }

        async function toggleLight() {
            if (!localStream) return;
            const track = localStream.getVideoTracks()[0];
            const settings = track.getSettings();
            try {
                await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
            } catch (e) {
                alert("ãƒ©ã‚¤ãƒˆåˆ¶å¾¡éå¯¾å¿œ");
            }
        }

        // æ˜ åƒã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã¨ãã«å†è¨ˆç®—
        window.addEventListener('resize', updateTransform);
    </script>
</body>
</html>
