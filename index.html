<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ›¸ç”»ã‚«ãƒ¡ãƒ©ãƒ»å…¨ç”»é¢æœ€é©åŒ–ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            background: #000; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
        }

        /* æ˜ åƒã‚¨ãƒªã‚¢ï¼šã“ã“ã‚’ã€ŒåŸºæº–ã€ã«ã—ã¦æ˜ åƒã‚’åã‚ã‚‹ */
        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        video { 
            position: absolute;
            /* å¸¸ã«å…¨ä½“ã‚’åã‚ã‚‹ãŸã‚ã®è¨­å®š */
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            transition: transform 0.3s ease;
        }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šé«˜ã•ã‚’å›ºå®šã—ã€ãƒœã‚¿ãƒ³ã‚’å¤§ããè¡¨ç¤º */
        .controls { 
            height: 100px; 
            background: #222; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            padding: 12px;
            box-sizing: border-box;
            border-top: 1px solid #444;
            z-index: 10;
        }

        button { 
            font-size: 16px; 
            border-radius: 12px; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        button:active { opacity: 0.7; }
        .btn-pc { background: #0066ff; }
        .btn-sm { background: #28a745; }
        .btn-rot { background: #555; }
        
        .icon { font-size: 22px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="video-container" id="container">
        <video id="videoView" autoplay playsinline></video>
    </div>

    <div class="controls">
        <button class="btn-pc" onclick="startMonitor()">
            <span class="icon">ğŸ’»</span>â‘  è¦–è´é–‹å§‹
        </button>
        <button class="btn-sm" onclick="startCamera()">
            <span class="icon">ğŸ“±</span>â‘¡ é…ä¿¡é–‹å§‹
        </button>
        <button class="btn-rot" onclick="toggleRotate()">
            <span class="icon">ğŸ”„</span>æ˜ åƒã‚’å›è»¢
        </button>
    </div>

    <script>
        const MONITOR_ID = 'seikeikai-monitor-2026';
        let peer = new Peer({ debug: 1 });
        let localStream;
        let rotation = 0;

        // PCå´ã®å‡¦ç†
        function startMonitor() {
            if (peer) peer.destroy();
            peer = new Peer(MONITOR_ID);
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    const video = document.getElementById('videoView');
                    video.srcObject = stream;
                    video.onloadedmetadata = () => updateTransform();
                });
            });
        }

        // ã‚¹ãƒãƒ›å´ã®å‡¦ç†
        async function startCamera() {
            const constraints = {
                video: {
                    width: { ideal: 3840, min: 1920 },
                    height: { ideal: 2160, min: 1080 },
                    facingMode: "environment",
                    frameRate: { max: 15 }
                },
                audio: false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('videoView');
                video.srcObject = localStream;
                const call = peer.call(MONITOR_ID, localStream);
                
                const pc = call.peerConnection;
                pc.oniceconnectionstatechange = async () => {
                    if (pc.iceConnectionState === 'connected') {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        params.encodings[0].maxBitrate = 20000000;
                        params.encodings[0].scaleResolutionDownBy = 1.0; 
                        await sender.setParameters(params);
                    }
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err);
            }
        }

        // å›è»¢ã¨ã‚µã‚¤ã‚ºèª¿æ•´ã®ãƒ­ã‚¸ãƒƒã‚¯
        function toggleRotate() { 
            rotation = (rotation + 90) % 360; 
            updateTransform();
        }

        function updateTransform() {
            const video = document.getElementById('videoView');
            const container = document.getElementById('container');
            
            // æ˜ åƒæœ¬æ¥ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const vWidth = video.videoWidth;
            const vHeight = video.videoHeight;
            if (!vWidth || !vHeight) return;

            if (rotation === 90 || rotation === 270) {
                // 90/270åº¦å›è»¢æ™‚ï¼š
                // ã€Œæ˜ åƒã®æ¨ªå¹…ã€ãŒã€Œã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã€ã«ã€ã€Œæ˜ åƒã®é«˜ã•ã€ãŒã€Œã‚³ãƒ³ãƒ†ãƒŠã®æ¨ªå¹…ã€ã«åã¾ã‚‹å€ç‡ã‚’è¨ˆç®—
                const ratio = Math.min(container.clientWidth / vHeight, container.clientHeight / vWidth);
                video.style.transform = `rotate(${rotation}deg) scale(${ratio})`;
                // å›è»¢æ™‚ã®ã‚ºãƒ¬ã‚’é˜²ããŸã‚ã€åŸºæº–ã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
                video.style.width = vWidth + "px";
                video.style.height = vHeight + "px";
            } else {
                // 0/180åº¦å›è»¢æ™‚ï¼š
                video.style.transform = `rotate(${rotation}deg) scale(1)`;
                video.style.width = "100%";
                video.style.height = "100%";
            }
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã‚‰è‡ªå‹•ã§å†èª¿æ•´
        window.addEventListener('resize', updateTransform);
    </script>
</body>
</html>
