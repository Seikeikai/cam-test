<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¸ç”»ã‚«ãƒ¡ãƒ©ãƒ»ãƒ—ãƒ­ä»•æ§˜</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* ç”»é¢å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        body { 
            font-family: sans-serif; 
            background: #000; 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* æ˜ åƒã‚¨ãƒªã‚¢ï¼šã“ã“ã‚’ç‹¬ç«‹ã•ã›ã‚‹ã“ã¨ã§ãƒœã‚¿ãƒ³è¢«ã‚Šã‚’é˜²ã */
        .video-container {
            flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦ä½¿ã† */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* å›è»¢ã—ãŸæ˜ åƒãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
            background: #111;
        }

        video { 
            max-width: 100%; 
            max-height: 100%; 
            background: #000; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            object-fit: contain;
        }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
        .controls { 
            height: 200px; /* ãƒ‘ãƒãƒ«ã®é«˜ã•ã‚’ç¢ºä¿ */
            background: #222; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            padding: 15px;
            box-sizing: border-box;
            border-top: 2px solid #444;
            z-index: 10; /* æ˜ åƒã‚ˆã‚Šå¸¸ã«ä¸Šã«è¡¨ç¤º */
        }

        button { 
            padding: 10px; 
            font-size: 16px; 
            border-radius: 10px; 
            border: none; 
            background: #444; 
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }

        button:active { background: #666; }
        .btn-main { background: #007bff; }
        .btn-sub { background: #28a745; }
        
        .status { 
            grid-column: span 3; 
            font-size: 13px; 
            color: #0f0; 
            background: #000; 
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        /* å°ã•ãªã‚¢ã‚¤ã‚³ãƒ³ä»£ã‚ã‚Šã®è¨˜å· */
        .icon { font-size: 20px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="videoView" autoplay playsinline></video>
    </div>

    <div class="controls">
        <div class="status" id="statusMsg">æº–å‚™å®Œäº†ï¼šPCã¾ãŸã¯ã‚¹ãƒãƒ›ã§é–‹å§‹ã—ã¦ãã ã•ã„</div>
        
        <button class="btn-main" onclick="startMonitor()">
            <span class="icon">ğŸ’»</span>â‘  PC<br>è¦–è´é–‹å§‹
        </button>
        <button class="btn-sub" onclick="startCamera()">
            <span class="icon">ğŸ“±</span>â‘¡ ã‚¹ãƒãƒ›<br>é…ä¿¡é–‹å§‹
        </button>
        <button onclick="location.reload()">
            <span class="icon">ğŸ”ƒ</span>ç”»é¢<br>ãƒªã‚»ãƒƒãƒˆ
        </button>
        
        <button onclick="toggleRotate()">
            <span class="icon">ğŸ”„</span>æ˜ åƒã‚’<br>å›è»¢
        </button>
        <button onclick="toggleLight()">
            <span class="icon">ğŸ’¡</span>ãƒ©ã‚¤ãƒˆ<br>ON/OFF
        </button>
        <button onclick="toggleZoom()">
            <span class="icon">ğŸ”</span>ã‚ºãƒ¼ãƒ <br>åˆ‡æ›¿
        </button>
    </div>

    <script>
        const MONITOR_ID = 'seikeikai-monitor-2026';
        let peer = new Peer({ debug: 1 });
        let localStream;
        let rotation = 0;
        let isZoomed = false;

        // ã€ãƒ¢ãƒ‹ã‚¿ãƒ¼å´ï¼ˆPCï¼‰ã€‘
        function startMonitor() {
            if (peer) peer.destroy();
            peer = new Peer(MONITOR_ID);
            peer.on('open', () => {
                document.getElementById('statusMsg').innerText = "PCï¼šå¾…æ©Ÿä¸­... ã‚¹ãƒãƒ›ã§é…ä¿¡ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚";
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    document.getElementById('videoView').srcObject = stream;
                    document.getElementById('statusMsg').innerText = "å—ä¿¡ä¸­ï¼šé«˜è§£åƒåº¦ãƒ¢ãƒ¼ãƒ‰";
                });
            });
        }

        // ã€ã‚«ãƒ¡ãƒ©å´ï¼ˆã‚¹ãƒãƒ›ï¼‰ã€‘
        async function startCamera() {
            document.getElementById('statusMsg').innerText = "ã‚¹ãƒãƒ›ï¼šã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
            const constraints = {
                video: {
                    width: { ideal: 3840, min: 1920 },
                    height: { ideal: 2160, min: 1080 },
                    facingMode: "environment",
                    frameRate: { max: 15 }
                },
                audio: false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('videoView').srcObject = localStream;
                const call = peer.call(MONITOR_ID, localStream);
                
                // ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆå›ºå®šå‡¦ç†
                const pc = call.peerConnection;
                pc.oniceconnectionstatechange = async () => {
                    if (pc.iceConnectionState === 'connected') {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        params.encodings[0].maxBitrate = 20000000; // 20Mbps
                        params.encodings[0].scaleResolutionDownBy = 1.0; 
                        await sender.setParameters(params);
                        document.getElementById('statusMsg').innerText = "é«˜è§£åƒåº¦é€šä¿¡ã‚’ç¢ºç«‹ã—ã¾ã—ãŸ";
                    }
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err);
            }
        }

        // æ˜ åƒèª¿æ•´æ©Ÿèƒ½
        function toggleRotate() { 
            rotation = (rotation + 90) % 360; 
            updateTransform(); 
        }

        function toggleZoom() { 
            isZoomed = !isZoomed; 
            updateTransform(); 
        }

        function updateTransform() {
            const video = document.getElementById('videoView');
            const scale = isZoomed ? 2.0 : 1.0;
            
            // å›è»¢ãŒ90åº¦ã‹270åº¦ã®å ´åˆã€ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã‚µã‚¤ã‚ºã‚’ç¸®å°èª¿æ•´ã™ã‚‹
            let baseScale = 1;
            if (rotation === 90 || rotation === 270) {
                // ç”»é¢ã®ç¸¦æ¨ªæ¯”ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´
                const container = document.querySelector('.video-container');
                const ratio = container.clientHeight / container.clientWidth;
                baseScale = Math.min(ratio, 1);
            }
            
            video.style.transform = `rotate(${rotation}deg) scale(${scale * baseScale})`;
        }

        async function toggleLight() {
            if (!localStream) return;
            const track = localStream.getVideoTracks()[0];
            const settings = track.getSettings();
            try {
                await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
            } catch (e) {
                alert("ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã¯ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            }
        }
    </script>
</body>
</html>
