<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç”»è³ªæ›¸ç”»ã‚«ãƒ¡ãƒ©ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; text-align: center; margin: 0; overflow: hidden; }
        /* æ˜ åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        video { width: 100dvw; height: 75dvh; object-fit: contain; background: #000; transition: transform 0.3s; }
        /* æ“ä½œãƒ‘ãƒãƒ« */
        .controls { padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #333; height: 25dvh; box-sizing: border-box; }
        button { padding: 10px; font-size: 14px; border-radius: 8px; border: none; background: #555; color: white; cursor: pointer; font-weight: bold; }
        button:active { background: #888; }
        .btn-main { background: #007bff; } /* ä¸»è¦ãƒœã‚¿ãƒ³ */
        .btn-sub { background: #28a745; }  /* ä¸»è¦ãƒœã‚¿ãƒ³ */
        .status { font-size: 12px; grid-column: span 3; color: #aaa; }
    </style>
</head>
<body>

    <video id="videoView" autoplay playsinline></video>

    <div class="controls">
        <div class="status" id="statusMsg">æº–å‚™ä¸­...</div>
        
        <button class="btn-main" onclick="startMonitor()">â‘  PC<br>è¦–è´é–‹å§‹</button>
        <button class="btn-sub" onclick="startCamera()">â‘¡ ã‚¹ãƒãƒ›<br>é…ä¿¡é–‹å§‹</button>
        <button onclick="location.reload()">ğŸ”ƒ<br>ãƒªã‚»ãƒƒãƒˆ</button>
        
        <button onclick="toggleRotate()">ğŸ”„<br>æ˜ åƒå›è»¢</button>
        <button onclick="toggleLight()">ğŸ’¡<br>ãƒ©ã‚¤ãƒˆ</button>
        <button onclick="toggleZoom()">ğŸ”<br>ã‚ºãƒ¼ãƒ </button>
    </div>

    <script>
        // IDã®è¨­å®šï¼šãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆå—ä¿¡ï¼‰ã¨ã‚«ãƒ¡ãƒ©ï¼ˆé€ä¿¡ï¼‰ã‚’æ˜ç¢ºã«åˆ†ã‘ã‚‹
        const MONITOR_ID = 'seikeikai-monitor-2026';
        const CAMERA_ID  = 'seikeikai-camera-2026';
        
        let peer;
        let localStream;
        let rotation = 0;
        let isZoomed = false;

        // Peerã®åˆæœŸåŒ–
        // ã‚¹ãƒãƒ›ã‹PCã‹åˆ¤æ–­ã—ã«ãã„ã®ã§ã€é–‹ã„ãŸç¬é–“ã«æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹
        peer = new Peer({
            debug: 2
        });

        peer.on('open', (id) => {
            document.getElementById('statusMsg').innerText = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå®Œäº†ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        });

        peer.on('error', (err) => {
            console.error(err);
            document.getElementById('statusMsg').innerText = "ã‚¨ãƒ©ãƒ¼: " + err.type;
        });

        // ã€â‘  PCï¼ˆãƒ¢ãƒ‹ã‚¿ãƒ¼å´ï¼‰ã®å‡¦ç†ã€‘
        function startMonitor() {
            // ãƒ¢ãƒ‹ã‚¿ãƒ¼ã¯ç‰¹å®šã®IDï¼ˆMONITOR_IDï¼‰ã§å¾…ã¡å—ã‘ãŸã„ã®ã§ã€ä¸€åº¦ä½œã‚Šç›´ã™
            if (peer) peer.destroy();
            
            peer = new Peer(MONITOR_ID);
            
            peer.on('open', () => {
                document.getElementById('statusMsg').innerText = "ãƒ¢ãƒ‹ã‚¿ãƒ¼å¾…æ©Ÿä¸­... ã‚¹ãƒãƒ›ã§é…ä¿¡ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚";
            });

            peer.on('call', call => {
                document.getElementById('statusMsg').innerText = "æ¥ç¶šä¸­...";
                call.answer(); // ç€ä¿¡ã«å¿œç­”
                call.on('stream', stream => {
                    document.getElementById('videoView').srcObject = stream;
                    document.getElementById('statusMsg').innerText = "å—ä¿¡ä¸­ï¼";
                });
            });
        }

        // ã€â‘¡ ã‚¹ãƒãƒ›ï¼ˆã‚«ãƒ¡ãƒ©å´ï¼‰ã®å‡¦ç†ã€‘
        async function startCamera() {
            document.getElementById('statusMsg').innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
            
            const constraints = {
                video: {
                    width: { ideal: 3840 }, 
                    height: { ideal: 2160 },
                    facingMode: "environment", // èƒŒé¢ã‚«ãƒ¡ãƒ©
                    frameRate: { ideal: 20 }
                },
                audio: false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('videoView').srcObject = localStream;
                
                document.getElementById('statusMsg').innerText = "ãƒ¢ãƒ‹ã‚¿ãƒ¼ã«æ¥ç¶šã—ã¦ã„ã¾ã™...";
                
                // ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆMONITOR_IDï¼‰ã«é›»è©±ã‚’ã‹ã‘ã‚‹
                const call = peer.call(MONITOR_ID, localStream);
                
                if(!call) {
                    alert("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚PCå´ãŒå¾…æ©ŸçŠ¶æ…‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©è¨±å¯ã‚¨ãƒ©ãƒ¼: " + err);
                document.getElementById('statusMsg').innerText = "ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
            }
        }

        // æ˜ åƒèª¿æ•´æ©Ÿèƒ½
        function toggleRotate() {
            rotation = (rotation + 90) % 360;
            updateTransform();
        }

        function toggleZoom() {
            isZoomed = !isZoomed;
            updateTransform();
        }

        function updateTransform() {
            const scale = isZoomed ? 1.5 : 1;
            document.getElementById('videoView').style.transform = `rotate(${rotation}deg) scale(${scale})`;
        }

        async function toggleLight() {
            if (!localStream) return;
            const track = localStream.getVideoTracks()[0];
            try {
                const settings = track.getSettings();
                await track.applyConstraints({
                    advanced: [{ torch: !settings.torch }]
                });
            } catch (e) {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶/ç«¯æœ«ã¯ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            }
        }
    </script>
</body>
</html>
