<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…é«˜è§£åƒåº¦ãƒ»æ›¸ç”»ã‚«ãƒ¡ãƒ©</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; overflow: hidden; }
        video { width: 100dvw; height: 75dvh; object-fit: contain; background: #000; transition: transform 0.3s; }
        .controls { padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #333; height: 25dvh; box-sizing: border-box; }
        button { padding: 10px; font-size: 14px; border-radius: 8px; border: none; background: #555; color: white; cursor: pointer; font-weight: bold; }
        button:active { background: #888; }
        .btn-main { background: #007bff; }
        .btn-sub { background: #28a745; }
        .status { font-size: 12px; grid-column: span 3; color: #00ff00; background: #000; padding: 2px; }
    </style>
</head>
<body>

    <video id="videoView" autoplay playsinline></video>

    <div class="controls">
        <div class="status" id="statusMsg">ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¾…æ©Ÿä¸­...</div>
        
        <button class="btn-main" onclick="startMonitor()">â‘  PC<br>è¦–è´é–‹å§‹</button>
        <button class="btn-sub" onclick="startCamera()">â‘¡ ã‚¹ãƒãƒ›<br>é…ä¿¡é–‹å§‹</button>
        <button onclick="location.reload()">ğŸ”ƒ<br>ãƒªã‚»ãƒƒãƒˆ</button>
        
        <button onclick="toggleRotate()">ğŸ”„<br>æ˜ åƒå›è»¢</button>
        <button onclick="toggleLight()">ğŸ’¡<br>ãƒ©ã‚¤ãƒˆ</button>
        <button onclick="toggleZoom()">ğŸ”<br>ã‚ºãƒ¼ãƒ </button>
    </div>

    <script>
        const MONITOR_ID = 'seikeikai-monitor-2026';
        let peer = new Peer({ debug: 2 });
        let localStream;
        let rotation = 0;
        let isZoomed = false;

        peer.on('open', (id) => {
            document.getElementById('statusMsg').innerText = "æº–å‚™å®Œäº†ã€‚PCã‹ã‚¹ãƒãƒ›ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        });

        // ã€â‘  å—ä¿¡å´ï¼šPCã€‘
        function startMonitor() {
            if (peer) peer.destroy();
            peer = new Peer(MONITOR_ID);
            peer.on('open', () => {
                document.getElementById('statusMsg').innerText = "ãƒ¢ãƒ‹ã‚¿ãƒ¼å¾…æ©Ÿä¸­... ã‚¹ãƒãƒ›ã‚’æ“ä½œã—ã¦ãã ã•ã„ã€‚";
            });
            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    document.getElementById('videoView').srcObject = stream;
                    document.getElementById('statusMsg').innerText = "å—ä¿¡ä¸­ï¼šé«˜è§£åƒåº¦ãƒ¢ãƒ¼ãƒ‰";
                });
            });
        }

        // ã€â‘¡ é€ä¿¡å´ï¼šã‚¹ãƒãƒ›ã€‘
        async function startCamera() {
            document.getElementById('statusMsg').innerText = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...";
            
            const constraints = {
                video: {
                    width: { ideal: 3840, min: 1920 }, // 4Kã‚’å„ªå…ˆã€æœ€ä½ã§ã‚‚ãƒ•ãƒ«HD
                    height: { ideal: 2160, min: 1080 },
                    facingMode: "environment",
                    frameRate: { max: 15 } // ã‚«ã‚¯ã¤ãã‚’è¨±å®¹ã—ã€1ã‚³ãƒã®ç”»è³ªã‚’ç¨¼ã
                },
                audio: false
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('videoView').srcObject = localStream;
                
                const call = peer.call(MONITOR_ID, localStream);
                
                // --- ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã¨è§£åƒåº¦ä¿æŒã®å¼·åˆ¶è¨­å®š ---
                const pc = call.peerConnection;
                pc.oniceconnectionstatechange = async () => {
                    if (pc.iceConnectionState === 'connected') {
                        const senders = pc.getSenders();
                        const sender = senders.find(s => s.track.kind === 'video');
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        
                        // ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã‚’20Mbpsã«è¨­å®šï¼ˆWi-Fiç’°å¢ƒæ¨å¥¨ï¼‰
                        params.encodings[0].maxBitrate = 20000000; 
                        // è§£åƒåº¦ã®ä½ä¸‹ã‚’çµ¶å¯¾ã«è¨±å¯ã—ãªã„
                        params.encodings[0].scaleResolutionDownBy = 1.0; 
                        
                        await sender.setParameters(params);
                        document.getElementById('statusMsg').innerText = "é«˜è§£åƒåº¦ãƒ­ãƒƒã‚¯å®Œäº†";
                    }
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err);
            }
        }

        function toggleRotate() { rotation = (rotation + 90) % 360; updateTransform(); }
        function toggleZoom() { isZoomed = !isZoomed; updateTransform(); }
        function updateTransform() {
            const scale = isZoomed ? 2.0 : 1;
            document.getElementById('videoView').style.transform = `rotate(${rotation}deg) scale(${scale})`;
        }
        async function toggleLight() {
            const track = localStream.getVideoTracks()[0];
            const settings = track.getSettings();
            await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
        }
    </script>
</body>
</html>
