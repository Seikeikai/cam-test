<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ç”»è³ªæ›¸ç”»ã‚«ãƒ¡ãƒ©ãƒ»ã‚·ãƒ³ãƒ—ãƒ«</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            background: #000; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
        }

        /* æ˜ åƒã‚¨ãƒªã‚¢ï¼šä½™ç™½ã‚’æœ€å°åŒ–ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        video { 
            position: absolute;
            background: #000;
            transition: transform 0.2s ease-out;
            will-change: transform;
        }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šãƒœã‚¿ãƒ³3ã¤ */
        .controls { 
            height: 100px; 
            background: #1a1a1a; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            padding: 12px;
            box-sizing: border-box;
            border-top: 1px solid #333;
            z-index: 100;
        }

        button { 
            font-size: 16px; 
            border-radius: 12px; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        button:active { opacity: 0.7; }
        .btn-sm { background: #28a745; } /* é…ä¿¡ */
        .btn-pc { background: #0066ff; } /* è¦–è´ */
        .btn-rot { background: #444; }    /* å›è»¢ */
        .icon { font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="video-container" id="container">
        <video id="videoView" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button class="btn-sm" onclick="startCamera()"><span class="icon">ğŸ“±</span>â‘  é…ä¿¡</button>
        <button class="btn-pc" onclick="startMonitor()"><span class="icon">ğŸ’»</span>â‘¡ è¦–è´</button>
        <button class="btn-rot" onclick="toggleRotate()"><span class="icon">ğŸ”„</span>â‘¢ å›è»¢</button>
    </div>

    <script>
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã®å›ºå®šID
        const MONITOR_ID = 'skk-simple-direct-2026'; 
        let peer = null;
        let rotation = 0;
        let localStream = null;

        // â‘  ã‚¹ãƒãƒ›å´ï¼šé…ä¿¡
        async function startCamera() {
            if (peer) peer.destroy();
            peer = new Peer(MONITOR_ID, { debug: 1 });
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 3840 }, height: { ideal: 2160 }, facingMode: "environment", frameRate: { max: 15 } },
                    audio: false
                });
                
                const video = document.getElementById('videoView');
                video.srcObject = localStream;

                peer.on('open', () => {
                    console.log("é…ä¿¡IDç™»éŒ²å®Œäº†");
                });

                // å—ä¿¡å¾…ã¡å—ã‘
                peer.on('call', call => {
                    call.answer(localStream);
                    setupHighBitrate(call);
                });

                video.onloadedmetadata = () => updateLayout();
            } catch (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err); }
        }

        // â‘¡ PCå´ï¼šè¦–è´
        function startMonitor() {
            if (peer) peer.destroy();
            peer = new Peer({ debug: 1 });
            
            peer.on('open', () => {
                const call = peer.call(MONITOR_ID, new MediaStream());
                
                call.on('stream', stream => {
                    const video = document.getElementById('videoView');
                    video.srcObject = stream;
                    video.onloadedmetadata = () => updateLayout();
                    video.play().catch(() => {});
                });

                // æ¥ç¶šç¢ºèª
                setTimeout(() => {
                    if (!document.getElementById('videoView').srcObject) {
                        alert("æ˜ åƒãŒå±Šãã¾ã›ã‚“ã€‚å…ˆã«ã‚¹ãƒãƒ›ã§ã€Œâ‘ é…ä¿¡ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                    }
                }, 4000);
            });
        }

        function setupHighBitrate(call) {
            const pc = call.peerConnection;
            pc.oniceconnectionstatechange = async () => {
                if (pc.iceConnectionState === 'connected') {
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        const params = sender.getParameters();
                        if (!params.encodings) params.encodings = [{}];
                        params.encodings[0].maxBitrate = 20000000;
                        params.encodings[0].scaleResolutionDownBy = 1.0;
                        await sender.setParameters(params);
                    }
                }
            };
        }

        function toggleRotate() {
            rotation = (rotation + 90) % 360;
            updateLayout();
        }

        function updateLayout() {
            const video = document.getElementById('videoView');
            const container = document.getElementById('container');
            const vW = video.videoWidth; const vH = video.videoHeight;
            if (!vW || !vH) return;

            const cW = container.clientWidth; const cH = container.clientHeight;
            let scale = (rotation === 0 || rotation === 180) 
                        ? Math.min(cW / vW, cH / vH) 
                        : Math.min(cW / vH, cH / vW);

            video.style.width = vW + "px";
            video.style.height = vH + "px";
            video.style.transform = `rotate(${rotation}deg) scale(${scale})`;
        }

        window.addEventListener('resize', updateLayout);
    </script>
</body>
</html>
